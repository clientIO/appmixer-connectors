{
    "name": "appmixer.google.bigquery.UpdatedRow",
    "author": "Camilo Manrique <camilo@client.io>",
    "description": "Watch for row updates in your BigQuery dataset.",
    "quota": {
        "manager": "appmixer:google:bigquery",
        "resources": "requests",
        "scope": {
            "userId": "{{userId}}"
        }
    },
    "private": false,
    "tick": true,
    "version": "1.0.3",
    "state": {
        "persistent": true
    },
    "auth": {
        "service": "appmixer:google",
        "scope": [
            "https://www.googleapis.com/auth/bigquery"
        ]
    },
    "properties": {
        "schema": {
            "type": "object",
            "properties": {
                "projectId":{ "type": "string" },
                "storeId": { "type": "string" },
                "query": { "type": "string" },
                "idField": { "type": "string" },
                "referenceFields": { "type": "string" }
            },
            "required": ["query", "idField", "projectId"]
        },
        "inspector": {
            "inputs": {
                "projectId": {
                    "type": "select",
                    "label": "Project",
                    "index": 1,
                    "source": {
                        "url": "/component/appmixer/google/bigquery/ListProjects?outPort=out",
                        "data": {
                            "transform": "./ListProjects#projectsToSelectArray"
                        }
                    },
                    "tooltip": "Select a BigQuery project from the list to run your query in."
                },
                "storeId": {
                    "type": "select",
                    "label": "Storage",
                    "index": 2,
                    "source": {
                        "url": "/component/appmixer/utils/storage/ListStores?outPort=out",
                        "data": {
                            "transform": "./ListStores#toSelectArray"
                        }
                    },
                    "tooltip": "Select a data store. The data store will be used to store data streamed from BigQuery so that we can compare them later to detect new rows. If you do not select a data store, one will be automatically created for you when the flow starts and deleted when the flow stops. If you do select a data store manually, you are responsible for clearing/deleting it when you don't need it anymore (note that the data in the data store is populated automatically, so any data left in the store affects the next flow run)."
                },
                "recordOldValues": {
                    "type": "toggle",
                    "label": "Record old values",
                    "index": 3,
                    "defaultValue": false,
                    "tooltip": "Include each updated row previous value in the output. In order to do this, is necessary to download all the existing rows to the store, which can be detrimental with very large tables"
                },
                "detectOnStop": {
                    "type": "toggle",
                    "index": 4,
                    "label": "Detect updated rows while stopped",
                    "tooltip": "If this is set to true, rows that are updated while the flow was stopped will be processed next time the flow is started."
                },
                "query": {
                    "type": "textarea",
                    "index": 5,
                    "label": "SQL Query",
                    "tooltip": "Enter an SQL query. If your query contains a <code>?</code> character placeholder, then the UpdatedRow component replaces the placeholder with the last timestamp (milliseconds since epoch) the component was triggered to query only data that has been added since the the last time the component was triggered. Note that the replaced timestamp is an integer, so you might need to use a function like TIMESTAMP_MILLIS to make date comparisons. Also note that this is only possible if your result set contains an \"updated_at\" type of field. A typical use case is, e.g. <code>select * from myproject.mydataset.mytable where updated_at > TIMESTAMP_MILLIS(?)</code>. If you do not provide the <code>?</code> placeholder, then the component will always query all data periodically."
                },
                "idField": {
                    "type": "text",
                    "label": "ID field",
                    "index": 6,
                    "tooltip": "Select a column that will be used as reference to detect updated rows. It should be an unique field."
                },
                "referenceFields": {
                    "when": { "eq": { "./recordOldValues": true } },
                    "type": "text",
                    "index": 7,
                    "label": "Reference Fields",
                    "tooltip": "A comma separated list of fields from the query result set that will be used to check for changes in rows. If you do not provide Reference Fields, any change in any field is detected."
                }
            }
        }
    },
    "outPorts": [
        {
            "name": "out",
            "source": {
                "url": "/component/appmixer/google/bigquery/UpdatedRowOutput?outPort=out",
                "data": {
                    "properties": {
                        "recordOldValues": "properties/recordOldValues"
                    }
                }
            }
        }
    ],
    "icon": "data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI1MDAiIHdpZHRoPSIyNTAwIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9Ii0xLjYzMzIzNTQzMzMyODI1NiA3LjAzMjYwOTMzMDMxNTY1NjUgMTMxLjI2NTc0NjgyNDE2ODc2IDExNC42MzQzOTA2Njk2ODQzNSI+PGxpbmVhckdyYWRpZW50IGlkPSJhIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIgeDE9IjY0IiB4Mj0iNjQiIHkxPSI3LjAzNCIgeTI9IjEyMC43ODkiPjxzdG9wIG9mZnNldD0iMCIgc3RvcC1jb2xvcj0iIzQzODdmZCIvPjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzQ2ODNlYSIvPjwvbGluZWFyR3JhZGllbnQ+PHBhdGggZD0iTTI3Ljc5IDExNS4yMTdMMS41NCA2OS43NDlhMTEuNDk5IDExLjQ5OSAwIDAgMSAwLTExLjQ5OWwyNi4yNS00NS40NjdhMTEuNSAxMS41IDAgMCAxIDkuOTYtNS43NWg1Mi41YTExLjUgMTEuNSAwIDAgMSA5Ljk1OSA1Ljc1bDI2LjI1IDQ1LjQ2N2ExMS40OTkgMTEuNDk5IDAgMCAxIDAgMTEuNWwtMjYuMjUgNDUuNDY3YTExLjUgMTEuNSAwIDAgMS05Ljk1OSA1Ljc0OWgtNTIuNWExMS40OTkgMTEuNDk5IDAgMCAxLTkuOTYtNS43NXoiIGZpbGw9InVybCgjYSkiLz48cGF0aCBjbGlwLXBhdGg9InVybCgjYikiIGQ9Ik0xMTkuMjI5IDg2LjQ4TDgwLjYyNSA0Ny44NzQgNjQgNDMuNDI1bC0xNC45MzMgNS41NUw0My4zIDY0bDQuNjM3IDE2LjcyOSA0MC45MzggNDAuOTM4IDguNjg3LS4zODZ6IiBvcGFjaXR5PSIuMDciLz48ZyBmaWxsPSIjZmZmIj48cGF0aCBkPSJNNjQgNDAuODA0Yy0xMi44MSAwLTIzLjE5NSAxMC4zODUtMjMuMTk1IDIzLjE5NiAwIDEyLjgxIDEwLjM4NSAyMy4xOTUgMjMuMTk1IDIzLjE5NVM4Ny4xOTQgNzYuODEgODcuMTk0IDY0YzAtMTIuODExLTEwLjM4NS0yMy4xOTYtMjMuMTk0LTIzLjE5Nm0wIDQwLjc5NWMtOS43MiAwLTE3LjYtNy44OC0xNy42LTE3LjZTNTQuMjggNDYuNCA2NCA0Ni40IDgxLjYgNTQuMjggODEuNiA2NCA3My43MiA4MS42IDY0IDgxLjYiLz48cGF0aCBkPSJNNTIuOTkgNjMuMTA0djcuMjFhMTIuNzk0IDEyLjc5NCAwIDAgMCA0LjM4IDQuNDc1VjYzLjEwNHpNNjEuNjc1IDU3LjAyNnYxOS40MTFjLjc0NS4xMzcgMS41MDcuMjIgMi4yOS4yMi43MTQgMCAxLjQxLS4wNzUgMi4wOTMtLjE4OVY1Ny4wMjZ6TTcwLjc2NiA2Ni4xdjguNTYyYTEyLjc4NiAxMi43ODYgMCAwIDAgNC4zODItNC43di0zLjg2MXpNODAuNjkxIDc4LjI4N2wtMi40MDMgMi40MDVhMS4wODggMS4wODggMCAwIDAgMCAxLjUzN2w5LjExNSA5LjExMmExLjA4OCAxLjA4OCAwIDAgMCAxLjUzNyAwbDIuNDAzLTIuNDAyYTEuMDkyIDEuMDkyIDAgMCAwIDAtMS41MzZsLTkuMTE2LTkuMTE2YTEuMDkgMS4wOSAwIDAgMC0xLjUzNiAwIi8+PC9nPjwvc3ZnPg=="
}
